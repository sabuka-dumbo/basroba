{% extends 'layout.html' %}
{% load static %}
{% load i18n %}

{% block head %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart - BASROBA</title>
    <meta name="description" content="View your shopping cart at BASROBA. Adjust quantities, check totals, and proceed to checkout.">
    <meta name="keywords" content="BASROBA, shopping cart, checkout, products, online store">
    <meta name="author" content="BASROBA">
    <link rel="canonical" href="{{ request.build_absolute_uri }}">

    <!-- Open Graph / Social Media -->
    <meta property="og:title" content="Cart - BASROBA">
    <meta property="og:description" content="View your shopping cart at BASROBA. Adjust quantities, check totals, and proceed to checkout.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:image" content="{% static 'pics/MainLogo.png' %}">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Cart - BASROBA">
    <meta name="twitter:description" content="View your shopping cart at BASROBA. Adjust quantities, check totals, and proceed to checkout.">
    <meta name="twitter:image" content="{% static 'pics/MainLogo.png' %}">

    <!-- Styles -->
    <link rel="stylesheet" href="{% static 'css/cart.css' %}">
{% endblock %}

{% block title %}
    Cart
{% endblock %}

{% block body %}
    <br>

    <div class="container">
        <div class="cart-items">
            <h1>{% trans "Cart" %} ({% if cart_items %}{{ cart_items.count }}){% else %}0{% endif %})</h1>
            {% for item in cart_items %}
                <div class="cart-item" data-cart-item-id="{{ item.id }}">
                    <div class="item-image">
                        <a href="{% url 'product' item.Item.id %}">
                            <img src="{{ item.Item.Product_image1.url }}" alt="{{ item.Item.Product_name }}">
                        </a>
                    </div>
                    <div class="item-details">
                        <a href="{% url 'product' item.Item.id %}" style="text-decoration: none; color: white">
                            <span class="item-name">{{ item.Item.Product_name }}</span>
                        </a>
                        <span class="item-price">₾{{ item.Item.Product_price_new }}</span>
                        <span class="item-price">{% trans "Color" %}: {{ item.Color }} || {% trans "Size" %}: {{ item.Size }}</span>
                    </div>
                    <div class="quantity">
                        <button class="btn-decrease" type="button">-</button>
                        <input type="number" value="{{ item.count }}" class="quantity-input" max="9" min="1" readonly>
                        <button class="btn-increase" type="button">+</button>
                    </div>
                </div>
            {% empty %}
                <p style="color: black; text-align: center;">{% trans "Your cart is empty." %}</p>
            {% endfor %}
        </div>

        <div class="order-summary">
            <div class="summary-item">
                <span class="summary-label">{% trans "Total Product Price" %}</span>
                <span class="summary-value" id="subtotal">₾0.00</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">{% trans "Tax % (Tax)" %}</span>
                <span class="summary-value" id="tax">₾0.00</span>
            </div>
            <div class="summary-item total">
                <span class="summary-label">{% trans "Total Amount" %}</span>
                <span class="summary-value" id="total">₾0.00</span>
            </div>
            <div class="checkout-btn">
                <button>{% trans "Checkout" %}</button>
            </div>
        </div>
    </div>
    <br>

    <script>
        function updateCartCount(cartItemId, newCount) {
            fetch("{% url 'update_cart_count' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}",
                },
                body: JSON.stringify({
                    cart_item_id: cartItemId,
                    count: newCount
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                updateTotals();
            })
            .catch(error => console.error(error));
        }

        const decreaseButtons = document.querySelectorAll('.btn-decrease');
        const increaseButtons = document.querySelectorAll('.btn-increase');

        decreaseButtons.forEach(button => {
            button.addEventListener('click', () => {
                const quantityInput = button.nextElementSibling;
                let currentValue = parseInt(quantityInput.value);
                if (currentValue > 1) {
                    quantityInput.value = currentValue - 1;

                    const cartItemId = button.closest('.cart-item').dataset.cartItemId;
                    updateCartCount(cartItemId, currentValue - 1);
                }
            });
        });

        increaseButtons.forEach(button => {
            button.addEventListener('click', () => {
                const quantityInput = button.previousElementSibling;
                let currentValue = parseInt(quantityInput.value);
                if (currentValue < 9) {
                    quantityInput.value = currentValue + 1;

                    const cartItemId = button.closest('.cart-item').dataset.cartItemId;
                    updateCartCount(cartItemId, currentValue + 1);
                }
            });
        });

        // Optional: Update subtotal/total dynamically
        function updateTotals() {
            let subtotal = 0;
            document.querySelectorAll('.cart-item').forEach(item => {
                const price = parseFloat(item.querySelector('.item-price').innerText.replace('₾',''));
                const count = parseInt(item.querySelector('.quantity-input').value);
                subtotal += price * count;
            });

            const tax = subtotal * 0.03; // example 3% tax
            const total = subtotal + tax;

            document.getElementById('subtotal').innerText = '₾' + subtotal.toFixed(2);
            document.getElementById('tax').innerText = '₾' + tax.toFixed(2);
            document.getElementById('total').innerText = '₾' + total.toFixed(2);
        }

        // Initial totals calculation
        updateTotals();
    </script>

{% endblock %}
