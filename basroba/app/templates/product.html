{% extends 'layout.html' %}
{% load static %}

{% block head %}
    <link rel="stylesheet" href="{% static 'css/product.css' %}">
    <style>
        /* Message bar */
        #message-bar {
            display: none;
            position: fixed;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 20px;
            z-index: 9999;
            transition: top 0.5s ease-in-out;
        }
        #message-bar.show {
            display: block;
            top: 20px;
        }
        #message-bar.success { background: green; }
        #message-bar.error { background: crimson; }
    </style>
{% endblock %}

{% block title %}
    {{ product.Product_name }}
{% endblock %}

{% block body %}
<form class="section1" onsubmit="return false;"> <!-- prevent reload -->

    <!-- Product Images -->
    <div class="pictures-div">
        <div class="other-pics">
            {% for img in product_images %}
                {% if img %}
                    <img src="{{ img.url }}" class="other-image" alt="{{ product.Product_name }}">
                {% endif %}
            {% endfor %}
        </div>
        <img src="{{ product.Product_image1.url }}" class="main-picture" alt="{{ product.Product_name }}">
    </div>

    <!-- Main Product Info -->
    <div class="main-part">
        <h1 class="product-title">{{ product.Product_name }}</h1>
        <h1 class="product-category">{{ product.Product_Category }}</h1>

        <div class="old-price1">
            {% if product.Product_price_old != "No" %}
                <h1 class="old-price2">₾{{ product.Product_price_old }}</h1>
                <hr class="old-price3">
                <h1 class="new-price">₾{{ product.Product_price_new }}</h1>
            {% else %}
                <h1 class="new-price">₾{{ product.Product_price_new }}</h1>
            {% endif %}
        </div>

        <h1 class="payment-method">{{ product.product_description }}</h1>

        <!-- Ratings -->
        <div class="rating-div">
            {% for i in "12345"|make_list %}
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-star-fill rating-icon" viewBox="0 0 16 16">
                    <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792
                             c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73
                             c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                </svg>
            {% endfor %}
            <h1 class="rating-text">{{ product.Product_rating }} შეფასება</h1>
        </div>

        <hr class="main-part-line">

        <!-- Colors -->
        <div class="color-picker">
            {% for color in product_colors %}
                <input type="radio" id="color{{ color.id }}" name="color" value="{{ color }}" {% if forloop.first %}checked{% endif %}>
                <label for="color{{ color.id }}" class="{{ color }}">{{ color.name }}</label>   
            {% endfor %}
        </div>

        <!-- Sizes -->
        <div class="size-selector">
            <div class="size-label">
                <h1 class="size-title">ზომა:</h1>
            </div>
            <div class="sizes">
                {% for size in available_sizes %}
                    <button class="size-button" type="button" data-size="{{ size }}">{{ size }}</button>
                {% endfor %}
            </div>
        </div>

        <!-- Buttons -->
        <div class="buttons-div" id="cart-button-div">
            {% if does_user_have_in_favorites %}
                <button id="favorite-button" class="first-button favorite-button2" type="button" onclick="toggle_favorite(true)">ფავორიტიდან ამოშლა</button>
            {% else %}
                <button id="favorite-button" class="first-button favorite-button2" type="button" onclick="toggle_favorite(false)">ფავორიტად არჩევა</button>
            {% endif %}

            {% if does_user_own_product %}
                <button id="cart-button" class="second-button add-to-cart-button2" onclick="toggle_cart(true)" type="button">კალათიდან ამოშლა</button>
            {% else %}
                <button id="cart-button" class="second-button add-to-cart-button2" type="button" onclick="toggle_cart(false)">კალათაში დამატება</button>
            {% endif %}
        </div>
    </div>
</form>

<!-- Message bar -->
<div id="message-bar"></div>

<script>
    // ========== Helpers ==========
    function showMessage(text, type="success") {
        const bar = document.getElementById("message-bar");
        bar.innerText = text;
        bar.className = type === "error" ? "error show" : "success show";
        setTimeout(() => {
            bar.classList.remove("show");
        }, 3000);
    }

    function getSelectedOptions() {
        const selectedColorInput = document.querySelector('input[name="color"]:checked');
        const selectedSize = document.querySelector('.size-button.selected');
        return {
            color: selectedColorInput ? selectedColorInput.value : null,
            size: selectedSize ? selectedSize.dataset.size : null
        };
    }

    // ========== Cart ==========
    function toggle_cart(in_cart) {
        const { color, size } = getSelectedOptions();

        if (!size) {
            showMessage("გთხოვთ აირჩიოთ ზომა!", "error");
            return;
        }

        const url = in_cart ? "/api/remove_from_cart/" : "/api/add_to_cart/";
        fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                product_id: "{{ product.id }}",
                size: size,
                color: color
            })
        })
        .then(response => response.json())
        .then(data => {
            if (in_cart) {
                document.getElementById("cart-button").outerHTML =
                    `<button id="cart-button" class="second-button add-to-cart-button2" type="button" onclick="toggle_cart(false)">კალათაში დამატება</button>`;
                showMessage("პროდუქტი ამოღებულია კალათიდან");
            } else {
                document.getElementById("cart-button").outerHTML =
                    `<button id="cart-button" class="second-button add-to-cart-button2" type="button" onclick="toggle_cart(true)">კალათიდან ამოშლა</button>`;
                showMessage("პროდუქტი დამატებულია კალათაში");
            }
        })
        .catch(error => {
            console.error("Error:", error);
            showMessage("დაფიქსირდა შეცდომა", "error");
        });
    }

    // ========== Favorites ==========
    function toggle_favorite(in_fav) {
        const url = in_fav ? "/api/remove_from_favorites/" : "/api/add_to_favorites/";
        fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                product_id: "{{ product.id }}"
            })
        })
        .then(response => response.json())
        .then(data => {
            if (in_fav) {
                document.getElementById("favorite-button").outerHTML =
                    `<button id="favorite-button" class="first-button favorite-button2" type="button" onclick="toggle_favorite(false)">ფავორიტად არჩევა</button>`;
                showMessage("პროდუქტი ამოღებულია ფავორიტებიდან");
            } else {
                document.getElementById("favorite-button").outerHTML =
                    `<button id="favorite-button" class="first-button favorite-button2" type="button" onclick="toggle_favorite(true)">ფავორიტიდან ამოშლა</button>`;
                showMessage("პროდუქტი დამატებულია ფავორიტებში");
            }
        })
        .catch(error => {
            console.error("Error:", error);
            showMessage("დაფიქსირდა შეცდომა", "error");
        });
    }

    // ========== Size selection ==========
    document.querySelectorAll('.size-button').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.size-button').forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            document.querySelector('.size-title').innerText = `ზომა: ${this.dataset.size}`;
        });
    });

    // ========== Image swap ==========
    const mainPic = document.querySelector('.main-picture');
    const thumbnails = document.querySelectorAll('.other-image');
    thumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', () => {
            const oldSrc = mainPic.src;
            mainPic.src = thumbnail.src;
            thumbnail.src = oldSrc;
        });
    });
</script>
{% endblock %}
