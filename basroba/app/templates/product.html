{% extends 'layout.html' %}
{% load static %}

{% block head %}
    <link rel="stylesheet" href="{% static 'css/product.css' %}">
{% endblock %}

{% block title %}
    {{ product.Product_name }}
{% endblock %}

{% block body %}
<div id="message-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

<form class="section1">
    <!-- Product Images -->
    <div class="pictures-div">
        <div class="other-pics">
            {% for img in product_images %}
                {% if img %}
                    <img src="{{ img.url }}" class="other-image" alt="{{ product.Product_name }}">
                {% endif %}
            {% endfor %}
        </div>
        <img src="{{ product.Product_image1.url }}" class="main-picture" alt="{{ product.Product_name }}">
    </div>

    <!-- Main Product Info -->
    <div class="main-part">
        <h1 class="product-title">{{ product.Product_name }}</h1>
        <h1 class="product-category">{{ product.Product_Category }}</h1>

        <div class="old-price1">
            {% if product.Product_price_old != "No" %}
                <h1 class="old-price2">₾{{ product.Product_price_old }}</h1>
                <hr class="old-price3">
                <h1 class="new-price">₾{{ product.Product_price_new }}</h1>
            {% else %}
                <h1 class="new-price">₾{{ product.Product_price_new }}</h1>
            {% endif %}
        </div>

        <h1 class="payment-method">{{ product.product_description }}</h1>

        <!-- Ratings -->
        <div class="rating-div">
            {% for i in "12345"|make_list %}
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-star-fill rating-icon" viewBox="0 0 16 16">
                    <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792
                             c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73
                             c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                </svg>
            {% endfor %}
            <h1 class="rating-text">{{ product.Product_rating }} შეფასება</h1>
        </div>

        <hr class="main-part-line">

        <!-- Colors -->
        <div class="color-picker">
            {% for color in product_colors %}
                <input type="radio" id="color{{ color.id }}" name="color" value="{{ color.name }}" {% if forloop.first %}checked{% endif %}>
                <label for="color{{ color.id }}" class="{{ color }}">{{ color.name }}</label>
            {% endfor %}
        </div>

        <!-- Sizes -->
        <div class="size-selector">
            <div class="size-label">
                <h1 class="size-title">ზომა:</h1>
            </div>
            <div class="sizes">
                {% for size in available_sizes %}
                    <button class="size-button" type="button" data-size="{{ size }}">{{ size }}</button>
                {% endfor %}
            </div>
        </div>

        <!-- Buttons -->
        <div class="buttons-div">
            <button class="first-button favorite-button2">ფავორიტად არჩევა</button>
            <button class="second-button add-to-cart-button2">კალათაში დამატება</button>
        </div>
    </div>
</form>

<script>
/* ---------- Size Selection ---------- */
document.querySelectorAll('.size-button').forEach(button => {
    button.addEventListener('click', function() {
        document.querySelectorAll('.size-button').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
        document.querySelector('.size-title').innerText = `ზომა: ${this.dataset.size}`;
    });
});

/* ---------- Thumbnail Swap ---------- */
const mainPic = document.querySelector('.main-picture');
const thumbnails = document.querySelectorAll('.other-image');

thumbnails.forEach(thumbnail => {
    thumbnail.addEventListener('click', () => {
        const oldSrc = mainPic.src;
        mainPic.src = thumbnail.src;
        thumbnail.src = oldSrc;
    });
});

/* ---------- Animated Messages ---------- */
function showMessage(text, type='info') {
    const container = document.getElementById('message-container');
    const msg = document.createElement('div');
    msg.classList.add('message', type);
    msg.innerText = text;
    container.appendChild(msg);

    // Animate in
    setTimeout(() => msg.classList.add('show'), 50);

    // Animate out after 2.5s
    setTimeout(() => {
        msg.classList.remove('show');
        setTimeout(() => container.removeChild(msg), 500);
    }, 2500);
}

/* ---------- Favorites Toggle ---------- */
const favoriteButton = document.querySelector('.favorite-button2');
favoriteButton.addEventListener('click', () => {
    fetch("{% url 'add_to_favorites' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `product_id={{ product.id }}`
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "added") {
            showMessage("პროდუქტი დაემატა ფავორიტებში!", "success");
            favoriteButton.innerText = "ფავორიტიდან ამოღება";
        } else if (data.status === "removed") {
            showMessage("პროდუქტი ამოღებულია ფავორიტებიდან!", "info");
            favoriteButton.innerText = "ფავორიტად არჩევა";
        } else {
            showMessage("შეცდომა დაფიქსირდა!", "error");
        }
    });
});

/* ---------- Add to Cart ---------- */
const cartButton = document.querySelector('.add-to-cart-button2');
cartButton.addEventListener('click', () => {
    const selectedSize = document.querySelector('.size-button.selected')?.dataset.size || "No";
    const selectedColor = document.querySelector('input[name="color"]:checked')?.value || "No";

    fetch("{% url 'add_to_cart' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `product_id={{ product.id }}&size=${selectedSize}&color=${selectedColor}`
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "added") {
            showMessage("პროდუქტი დაემატა კალათაში!", "success");
        } else {
            showMessage("შეცდომა დაფიქსირდა!", "error");
        }
    });
});
</script>

{% endblock %}
