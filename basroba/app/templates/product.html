{% extends 'layout.html' %}
{% load static %}

{% block head %}
    <link rel="stylesheet" href="{% static 'css/product.css' %}">
{% endblock %}

{% block title %}
    {{ product.Product_name }}
{% endblock %}

{% block body %}
<form class="section1">
    <!-- Product Images -->
    <div class="pictures-div">
        <div class="other-pics">
            {% for img in product_images %}
                {% if img %}
                    <img src="{{ img.url }}" class="other-image" alt="{{ product.Product_name }}">
                {% endif %}
            {% endfor %}
        </div>
        <img src="{{ product.Product_image1.url }}" class="main-picture" alt="{{ product.Product_name }}">
    </div>

    <!-- Main Product Info -->
    <div class="main-part">
        <h1 class="product-title">{{ product.Product_name }}</h1>
        <h1 class="product-category">{{ product.Product_Category }}</h1>

        <div class="old-price1">
            {% if product.Product_price_old != "No" %}
                <h1 class="old-price2">₾{{ product.Product_price_old }}</h1>
                <hr class="old-price3">
                <h1 class="new-price">₾{{ product.Product_price_new }}</h1>
            {% else %}
                <h1 class="new-price">₾{{ product.Product_price_new }}</h1>
            {% endif %}
        </div>

        <h1 class="payment-method">{{ product.product_description }}</h1>

        <!-- Ratings -->
        <div class="rating-div">
            {% for i in "12345"|make_list %}
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-star-fill rating-icon" viewBox="0 0 16 16">
                    <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792
                             c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73
                             c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                </svg>
            {% endfor %}
            <h1 class="rating-text">{{ product.Product_rating }} შეფასება</h1>
        </div>

        <hr class="main-part-line">

        <!-- Colors -->
        <div class="color-picker">
            {% for color in product_colors %}
                <input type="radio" id="color{{ color.id }}" name="color" value="{{ color }}" {% if forloop.first %}checked{% endif %}>
                <label for="color{{ color.id }}" class="{{ color }}">{{ color.name }}</label>   
            {% endfor %}
        </div>

        <!-- Sizes -->
        <div class="size-selector">
            <div class="size-label">
                <h1 class="size-title">ზომა:</h1>
            </div>
            <div class="sizes">
                {% for size in available_sizes %}
                    <button class="size-button" type="button" data-size="{{ size }}">{{ size }}</button>
                {% endfor %}
            </div>
        </div>

        <!-- Buttons -->
        <div class="buttons-div" id="cart-button-div">
            <button class="first-button favorite-button2">ფავორიტად არჩევა</button>

            {% if does_user_own_product %}
                <button class="second-button add-to-cart-button2" onclick="remove_from_cart()" type="button">კალათიდან ამოშლა</button>
            {% else %}
                <button class="second-button add-to-cart-button2" id="cart-add" type="button" onclick="add_to_cart()">კალათაში დამატება</button>
            {% endif %}
        </div>
    </div>
</form>

<script>
    document.querySelectorAll('.size-button').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.size-button').forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            document.querySelector('.size-title').innerText = `ზომა: ${this.dataset.size}`;
        });
    });

        const mainPic = document.querySelector('.main-picture');
    const thumbnails = document.querySelectorAll('.other-image');

    thumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', () => {
            const oldSrc = mainPic.src;
            mainPic.src = thumbnail.src;
            thumbnail.src = oldSrc;
        });
    });


    function add_to_cart() {
        const selectedColorInput = document.querySelector('input[name="color"]:checked');
        const selectedSize = document.querySelector('.size-button.selected');

        const colorValue = selectedColorInput ? selectedColorInput.value : null;

        fetch("/api/add_to_cart/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                product_id: "{{ product.id }}",
                size: selectedSize ? selectedSize.dataset.size : null,
                color: colorValue
            })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('cart-button-div').innerHTML = `
                <button class="first-button favorite-button2" type="button">ფავორიტად არჩევა</button>

                <button class="second-button add-to-cart-button2" onclick="remove_from_cart()" type="button">კალათიდან ამოშლა</button>
            `;
        })
        .catch(error => {
            console.error("Error:", error);
        });
    };


    function remove_from_cart() {
        const selectedColorInput = document.querySelector('input[name="color"]:checked');
        const selectedSize = document.querySelector('.size-button.selected');

        const colorValue = selectedColorInput ? selectedColorInput.value : null;

        fetch("/api/remove_from_cart/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                product_id: "{{ product.id }}",
                size: selectedSize ? selectedSize.dataset.size : null,
                color: colorValue
            })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('cart-button-div').innerHTML = `
                <button class="first-button favorite-button2" type="button">ფავორიტად არჩევა</button>

                <button class="second-button add-to-cart-button2" id="cart-add" type="button" onclick="add_to_cart()">კალათაში დამატება</button>
            `;
        })
        .catch(error => {
            console.error("Error:", error);
        });
    };

</script>
{% endblock %}
