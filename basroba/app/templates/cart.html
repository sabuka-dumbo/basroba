{% extends 'layout.html' %}
{% load static %}

{% block head %}
    <link rel="stylesheet" href="{% static 'css/cart.css' %}">
{% endblock %}


{% block title %}
{% endblock %}

{% block body %}
    <br>

    <div class="container">
        <div class="cart-items">
            <h1>კალათა ({{ cart_items.count }})</h1>
            {% for item in cart_items %}
            <div class="cart-item" data-cart-item-id="{{ item.id }}">
                </div>
                <div class="cart-item">
                    <div class="item-image">
                        <img src="{{ item.Item.Product_image1.url }}" alt="Item">
                    </div>
                    <div class="item-details">
                        <span class="item-name">{{ item }}</span>
                        <span class="item-price">₾{{ item.Item.Product_price_new }}</span>
                    </div>
                    <div class="quantity">
                        <button class="btn-decrease" type="button">-</button>
                        <input type="number" value="{{ item.count }}" class="quantity-input" max="9" min="1" readonly>
                        <button class="btn-increase" type="button">+</button>
                    </div>
                </div>
            {% endfor %}
        </div>

        <div class="order-summary">
            <div class="summary-item">
                <span class="summary-label">პროდუქტის(თი) სუბთოტი</span>
                <span class="summary-value">₾319.92</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">სადასტური (Tax)</span>
                <span class="summary-value">₾319.92</span>
            </div>
            <div class="summary-item total">
                <span class="summary-label">მოთხოვნა სავალდებულო</span>
                <span class="summary-value">₾319.92</span>
            </div>
            <div class="checkout-btn">
                <button>შეკვეთის გაფორმება</button>
            </div>
        </div>
    </div>

    <br>

<script>
const decreaseButtons = document.querySelectorAll('.btn-decrease');
const increaseButtons = document.querySelectorAll('.btn-increase');

function updateCartCount(cartItemId, newCount) {
    fetch("{% url 'update_cart_count' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({
            cart_item_id: cartItemId,
            count: newCount
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log(data);
    })
    .catch(error => console.error(error));
}

decreaseButtons.forEach(button => {
    button.addEventListener('click', () => {
        const quantityInput = button.nextElementSibling;
        let currentValue = parseInt(quantityInput.value);
        if (currentValue > 1) {
            quantityInput.value = currentValue - 1;

            // Get cart item ID from data attribute
            const cartItemId = button.closest('.cart-item').dataset.cartItemId;
            updateCartCount(cartItemId, currentValue - 1);
        }
    });
});

increaseButtons.forEach(button => {
    button.addEventListener('click', () => {
        const quantityInput = button.previousElementSibling;
        let currentValue = parseInt(quantityInput.value);
        if (currentValue < 9) {
            quantityInput.value = currentValue + 1;

            const cartItemId = button.closest('.cart-item').dataset.cartItemId;
            updateCartCount(cartItemId, currentValue + 1);
        }
    });
});
</script>

{% endblock %}